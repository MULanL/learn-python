# 快速上手

## 获取简单验证码(以知乎和新浪为例)

> [https://www.zhihu.com/signin](https://www.zhihu.com/signin)

![zhihu-code.jpeg](data:image/jpg;base64,R0lGODdhlgA8AIcAAP7+/gEBARYWFtjY2Ofn5yYmJsjIyFdXV0dHR3Z2doeHh7m5uWZmZjU1Naio
qJeXlzk5OfLy8qenp52dnevr6ywsLLa2toaGhgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACwAAAAAlgA8AEAI/wABCBxI
sKDBgwgTKlzIsKHDhxAjSpxIsaLFixgzOgjAkQEBACBDihxJsqRJkwQGAFjJsqXLlzBjSigQIMAB
ADhz6tzJs6fPn0B3MggQAMGCBQgCHFgAoKnTCA8KBJiagACDAFgFFEDggACAr2AHPIAQQAGAAQcC
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
XNjwYcSJFS9m3NjxY8hrAwIAOw== 'zhihu-code.jpeg')

> [https://login.sina.com.cn/cgi/pin.php](https://login.sina.com.cn/cgi/pin.php)

![sina-code.png](https://login.sina.com.cn/cgi/pin.php 'sina-code.png')

## 检测是否已安装独立 tesseract 软件

```bash
tesseract --help
```

## 快速上手 tesseract 识别验证码

```bash
tesseract sina-code.png sina-code
```

> tesseract zhihu-code.jpeg zhihu-code

## 查看已安装语言包

> [https://github.com/tesseract-ocr/tessdata](https://github.com/tesseract-ocr/tessdata)

```bash
tesseract --list-langs
```

```bash
tesseract snowdreams1006.png snowdreams1006 -l eng
```

> tesseract 雪之梦技术驿站.png 雪之梦技术驿站 -l chi_sim

## 检测是否已安装 pytesseract 包

> pip freeze | grep pytesseract

```python
import pytesseract
```

> pip install pytesseract : 默认还会安装依赖 Pillow,也可以手动安装 pip install Pillow

## 快速上手 pytesseract 识别验证码

> [https://github.com/madmaze/pytesseract](https://github.com/madmaze/pytesseract)

```python
# -*- coding: utf-8 -*-
import pytesseract
from PIL import Image

def use_simple_text_image(image_name,lang='eng'):
    image = Image.open(image_name)
    code = pytesseract.image_to_string(image,lang=lang)
    print(code)

def main():
    use_simple_text_image('snowdreams1006.png')

if __name__ == '__main__':
    main()
```

> 默认识别语言为英语,如果待识别图像内容是其他语言,需要指定语言,如简体中文则是: chi_sim
>
> print(pytesseract.image_to_string(Image.open('雪之梦技术驿站.png'), lang='chi_sim'))
>
> 如果 tesseract 不在PATH环境变量中,需要指定可执行路径,如 win 一般为: C:\Program Files (x86)\Tesseract-OCR\tesseract
>
> pytesseract.pytesseract.tesseract_cmd = r'full_path_to_your_tesseract_executable'
>
> r'C:\Program Files (x86)\Tesseract-OCR\tesseract'

## 图片预处理

### 转灰度

> image.convert('L')

```python
from PIL import Image

def convert_gray_image(image_name):
    image = Image.open(image_name)
    # 转灰度
    gray_image = image.convert('L')
    # 显示图片,方便及时查看效果
    gray_image.show()
```

### 二值化

> image.convert('1')

```python
from PIL import Image

def convert_binarization_image(image_name):
    image = Image.open(image_name)
    # 二值化
    binarization_image = image.convert('1')
    # 显示图片,方便及时查看效果
    binarization_image.show()
```

一般不会直接转换原图,先将原图转化成灰度图,再指定阈值进行二值化处理.

> image.point(table,'1')

```python
from PIL import Image

def convert_binarization_image(image_name):
    image = Image.open(image_name)
    # 二值化,默认阈值 127
    table = []
    threshold = 160
    for i in  range(256):
        if i < threshold:
            table.append(0)
        else:
            table.append(1)
    binarization_image = image.point(table,'1')
    # 显示图片,方便及时查看效果
    binarization_image.show()
```

> image.load() image.size

```python
from PIL import Image

def convert_binarization_image(image_name):
    image = Image.open(image_name)
    # 二值化,默认阈值 127
    threshold = 160
    pixels = image.load()
    for x in range(image.width):
        for y in range(image.height):
            if pixels[x, y] < standard:
                pixels[x, y] = 0
            else:
                pixels[x, y] = 255
    # 显示图片,方便及时查看效果
    image.show()
```

### 剔除无关字符

> re.sub("\W", "", code)

```python
# -*- coding: utf-8 -*-
import pytesseract
from PIL import Image
import re

def use_simple_text_image(image_name,lang='eng'):
    image = Image.open(image_name)
    code = pytesseract.image_to_string(image,lang=lang)
    print(code)
    code = re.sub("\W", "", code)
    print(code)

def main():
    use_simple_text_image('zhihu.jpeg')

if __name__ == '__main__':
    main()
```


---


```python
# -*- coding: utf-8 -*-

import pytesseract
from PIL import Image
import re

def clear_image(image):
    image = image.convert('RGB')
    width = image.size[0]
    height = image.size[1]
    noise_color = get_noise_color(image)
    
    for x in range(width):
        for y in  range(height):
            #清除边框和干扰色
            rgb = image.getpixel((x, y))
            if (x == 0 or y == 0 or x == width - 1 or y == height - 1 
                or rgb == noise_color or rgb[1]>100):
                image.putpixel((x, y), (255, 255, 255))
    return image

def get_noise_color(image):
    for y in range(1, image.size[1] - 1):
        # 获取第2列非白的颜色
        (r, g, b) = image.getpixel((2, y))
        if r < 255 and g < 255 and b < 255:
            return (r, g, b)

image = Image.open('code4.png')
image = clear_image(image)
#转化为灰度图
imgry = image.convert('L')
code = pytesseract.image_to_string(imgry)

imgry.save("imgry1.png")
with open("code.txt", "w") as f:
    print(code)
    f.write(str(code))
```


## 参考文档

- [Python 实现识别弱图片验证码](https://www.jianshu.com/p/bc6774723003)
- [Python之验证码识别](https://my.oschina.net/moluyingxing/blog/2996786)
- [selenium自动化测试+获取验证码图片](https://my.oschina.net/moluyingxing/blog/2997353)
- [Selenium+验证码打码时的特殊情况](http://www.51testing.com/html/90/n-3726590.html)
- [【Mac + Python + Selenium】之获取验证码图片code并进行登录](https://www.cnblogs.com/Owen-ET/p/12206857.html)